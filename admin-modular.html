<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Broadcast Ops Console â€” Admin (Modular)</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#0b141a; --panel:#111b21; --ink:#e9edef; --muted:#aebac1; --accent:#53bdeb; --line:#1f2c34;
      --green:#00a884; --red:#ff6b6b; --yellow:#ffd166; --chip:#202c33; --incoming:#202c33; --outgoing:#005c4b;
      
      /* Safe area insets for iPhone */
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-right: env(safe-area-inset-right);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      
      /* Dynamic viewport height for mobile keyboards */
      --vh: 1vh;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      /* Default desktop body - no safe area padding */
    }
    
    /* Desktop layout - default */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 360px 1fr 320px;
      grid-template-rows: 1fr;
      position: relative;
    }

    /* LEFT: chats list */
    .sidebar{background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .left-head{padding:12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .left-head input{flex:1;background:#111b21;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
    .tab{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--muted);cursor:pointer}
    .tab.active{background:#0e2a36;color:var(--accent)}
    .chatlist{overflow:auto}
    .item{display:grid;grid-template-columns: 44px 1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:hover{background:#0f1f26}
    .avatar{width:44px;height:44px;border-radius:50%;background:#25313a;display:grid;place-items:center;color:#9cc4ff;font-weight:700}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px}
    .badge{background:#1f2c34;color:#9fe1ff;border:1px solid #2b3b45;font-size:11px;border-radius:999px;padding:2px 8px}
    .unread{background:#1fa855;color:white;border:none}

    /* CENTER: thread */
    .thread{display:flex;flex-direction:column;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>')}
    .thread-head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:var(--panel)}
    .thread-head .name{font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);font-size:11px;border-radius:999px;padding:3px 8px}
    .area{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:8px 10px;border-radius:10px;position:relative}
    .in{align-self:flex-start;background:var(--incoming)}
    .out{align-self:flex-end;background:var(--outgoing)}
    .stamp{font-size:11px;color:#b7c7ce;opacity:.85;margin-top:2px}
    
    /* Message type indicators */
    .msg[data-type="1"] { border-left: 3px solid #53bdeb; } /* Bot template */
    .msg[data-type="2"] { border-left: 3px solid #00a884; } /* Client */
    .msg[data-type="3"] { border-left: 3px solid #ffd166; } /* AI */
    .msg[data-type="4"] { border-left: 3px solid #ff6b6b; } /* Admin */

    /* composer */
    .composer{display:grid;grid-template-columns: 1fr auto auto;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--panel)}
    .composer textarea{width:100%;min-height:40px;resize:vertical;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .takeover{background:var(--yellow);color:#1b1b1b}
    .send{background:var(--green);color:#00170f}
    .quick{background:#0f191f;color:var(--muted)}

    /* RIGHT: info */
    .right{background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
    .right-head{padding:12px;border-bottom:1px solid var(--line);font-weight:600}
    .section{padding:12px;border-bottom:1px solid var(--line)}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:var(--muted)}
    .tag{background:#0f191f;border:1px solid var(--line);color:#9cc4ff;border-radius:999px;padding:3px 8px;font-size:11px;margin:2px;display:inline-block}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:#0f191f;color:var(--ink);border:1px solid var(--line)}

    /* toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0f191f;border:1px solid var(--line);padding:10px 12px;border-radius:8px;display:none}
    
    /* Desktop specific styles - ensure proper three-column layout */
    @media (min-width: 769px) {
      .app {
        height: 100%;
        display: grid !important;
        grid-template-columns: 360px 1fr 320px !important;
        grid-template-rows: 1fr;
        flex-direction: initial !important;
        position: relative;
        overflow: initial;
      }
      
      .sidebar, .thread, .right {
        position: static !important;
        transform: none !important;
        width: auto !important;
        height: 100% !important;
        z-index: auto !important;
        transition: none !important;
      }
      
      .sidebar {
        background: var(--panel);
        border-right: 1px solid var(--line);
        display: flex;
        flex-direction: column;
      }
      
      .thread {
        display: flex;
        flex-direction: column;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>');
      }
      
      .right {
        background: var(--panel);
        border-left: 1px solid var(--line);
        display: flex;
        flex-direction: column;
      }
      
      /* Reset mobile composer styles for desktop */
      .composer {
        display: grid !important;
        grid-template-columns: 1fr auto auto !important;
        gap: 8px !important;
        padding: 10px !important;
        border-top: 1px solid var(--line);
        background: var(--panel);
        position: static !important;
        transform: none !important;
        z-index: auto !important;
      }
      
      .composer textarea {
        width: 100%;
        min-height: 40px;
        resize: vertical;
        background: #0f191f;
        color: var(--ink);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        font-size: 14px !important;
        touch-action: auto;
      }
      
      .send {
        background: var(--green);
        color: #00170f;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
        min-width: auto;
        height: auto;
        display: initial;
        align-items: initial;
        justify-content: initial;
        font-size: 14px;
      }
      
      .quick {
        display: block !important;
        background: #0f191f;
        color: var(--muted);
      }
    }
    
    /* === MOBILE RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
      body{
        font-size:14px;
        overflow:hidden;
        margin:0;
        padding:0;
        /* iPhone safe area support - mobile only */
        padding-top: var(--safe-area-inset-top);
        padding-left: var(--safe-area-inset-left);
        padding-right: var(--safe-area-inset-right);
      }
      
      .app{
        height: calc(var(--vh, 1vh) * 100);
        min-height: -webkit-fill-available;
        width:100vw;
        display:flex;
        flex-direction:column;
        grid-template-columns:none;
        grid-template-rows:none;
        position:relative;
        overflow:hidden;
      }
      
      /* Mobile layout - stack vertically */
      .sidebar, .thread, .right {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1;
      }
      
      .sidebar {
        transform: translateX(0);
        z-index: 10;
      }
      
      /* Mobile composer fixes */
      .composer{
        padding: calc(16px + var(--safe-area-inset-bottom)) 16px 16px 16px;
        grid-template-columns:1fr auto;
        gap:12px;
        background:var(--panel);
        border-top:1px solid var(--line);
        flex-shrink:0;
        position: relative;
        z-index: 100;
        transform: translateZ(0);
      }
      
      .composer textarea{
        font-size:16px !important;
        min-height:44px;
        padding:12px 16px;
        border-radius:24px;
        border:1px solid var(--line);
        background:var(--bg);
        touch-action: manipulation;
        resize: none;
        -webkit-appearance: none;
        appearance: none;
      }
      
      .composer textarea:focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        position: relative;
        z-index: 101;
      }
      
      .send{
        min-width:48px;
        height:48px;
        border-radius:50%;
        padding:0;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:18px;
      }
      
      .quick{display:none}
      
      /* iPhone specific fixes */
      @supports (-webkit-touch-callout: none) {
        .app {
          height: calc(var(--vh, 1vh) * 100);
          min-height: -webkit-fill-available;
        }
        
        .composer {
          padding-bottom: calc(16px + var(--safe-area-inset-bottom, 20px));
          position: sticky;
          bottom: 0;
        }
        
        .composer textarea {
          font-size: 16px !important;
          transform: scale(1);
          -webkit-user-select: text;
          user-select: text;
        }
      }
      
      /* Keyboard open state for iPhone */
      body.keyboard-open .composer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: var(--panel);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      }
      
      body.keyboard-open .thread {
        padding-bottom: 100px;
      }
      
      body.keyboard-open .area {
        padding-bottom: 20px;
      }
      
      /* Mobile improvements */
      .area{
        padding:16px;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
      }
      
      .msg{
        max-width:80%;
        padding:12px 16px;
        margin:6px 0;
        font-size:15px;
        line-height:1.4;
        border-radius:16px;
      }
      
      /* Mobile sidebar improvements */
      .sidebar{
        background:var(--bg);
        border-right:none;
      }
      
      .left-head{
        padding:16px;
        border-bottom:1px solid var(--line);
        background:var(--panel);
      }
      
      .left-head input{
        font-size:16px;
        padding:12px 16px;
        border-radius:12px;
        width:100%;
      }
      
      .chatlist{
        flex:1;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
        padding:8px 0;
      }
      
      .item{
        padding:16px;
        grid-template-columns:48px 1fr auto;
        gap:12px;
        margin:0 8px;
        border-radius:12px;
        border-bottom:none;
      }
      
      .avatar{width:48px;height:48px;font-size:16px}
      .title{font-size:16px;font-weight:600}
      .meta{font-size:13px;margin-top:2px}
    }
  </style>
</head>
<body>
<div class="app" id="app">

  <!-- LEFT -->
  <aside class="sidebar">
    <div class="left-head">
      <input id="search" placeholder="Search or filter (name, tag)..." />
      <button class="ghost" id="refresh" style="padding: 8px; font-size: 12px;">ðŸ”„</button>
      <div id="connection-status" style="width: 8px; height: 8px; border-radius: 50%; background: #666; margin-left: 4px;" title="Connection status"></div>
    </div>
    <div class="tabs">
      <div class="tab active" data-filter="all">All</div>
      <div class="tab" data-filter="unread">Unread</div>
      <div class="tab" data-filter="attention">Attention</div>
    </div>
    <div class="chatlist" id="chatlist"></div>
  </aside>

  <!-- CENTER -->
  <main class="thread">
    <div class="thread-head">
      <div class="avatar" id="av"></div>
      <div>
        <div class="name" id="who">â€”</div>
        <div class="chips" id="chips"></div>
      </div>
    </div>
    <div class="area" id="area"></div>
    <div class="composer">
      <textarea id="text" placeholder="Write to intervene manually..."></textarea>
      <button class="quick" id="quick">Quick Replies</button>
      <button class="send" id="send">Send</button>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="right">
    <div class="right-head">Contact Card</div>
    <div class="section" id="profile">
      <div class="row"><span>Source</span><span id="src">Whats</span></div>
      <div class="row"><span>Phone</span><span id="phone">â€”</span></div>
      <div class="row"><span>Status</span><span id="status">Bot active</span></div>
      <div class="row"><span>Interview</span><span id="interview">â€”</span></div>
      <div class="row"><span>Last message</span><span id="last">â€”</span></div>
      <div class="row"><span>Time zone</span><span id="tz">UTCâˆ’6</span></div>
      <div style="margin-top:8px">
        <span class="tag">lead</span><span class="tag">fx</span><span class="tag">broadcast</span>
      </div>
      <div class="buttons">
        <button class="ghost" id="toggle">Take control</button>
        <button class="ghost" id="open8n8">Open in 8n8</button>
        <button class="ghost" id="viewThread">View in source</button>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Notes</div>
      <textarea id="note" style="width:100%;min-height:80px;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px" placeholder="Internal notes (not sent to the client)"></textarea>
      <div class="buttons"><button class="ghost" id="saveNote">Save note</button></div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Message Types</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.4">
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#53bdeb;margin-right:6px"></span>Bot Template</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#00a884;margin-right:6px"></span>Client Message</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ffd166;margin-right:6px"></span>AI Response</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ff6b6b;margin-right:6px"></span>Admin Intervention</div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Quick Actions</div>
      <div class="buttons">
        <button class="ghost" data-quick="Thanks for the reply â€” here's our Telegram channel: https://t.me/tradetabofficial">Invite to Telegram</button>
        <button class="ghost" data-quick="All good â€” we'll keep you posted with neutral market commentary only.">Confirm subscription</button>
        <button class="ghost" data-quick="Understood. I've removed you from the list. You can rejoin anytime.">Unsubscribe</button>
      </div>
    </div>
  </aside>
</div>

<div class="toast" id="toast"></div>

<!-- iPhone viewport height fix -->
<script>
// Fix for iPhone viewport height and keyboard handling
function setVH() {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Set initial viewport height
setVH();

// Update on resize (keyboard open/close)
window.addEventListener('resize', setVH);

// Additional iPhone keyboard handling
if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
  // Prevent zoom on input focus
  document.addEventListener('touchstart', function() {}, {passive: true});
  
  // Handle keyboard show/hide
  let initialViewportHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;
    
    // Keyboard is likely open if height decreased by more than 150px
    if (heightDifference > 150) {
      document.body.classList.add('keyboard-open');
      // Scroll to focused element
      setTimeout(() => {
        const focused = document.activeElement;
        if (focused && focused.tagName === 'TEXTAREA') {
          focused.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 300);
    } else {
      document.body.classList.remove('keyboard-open');
    }
  });
}
</script>

<!-- Load modular JavaScript files -->
<script src="js/config.js"></script>
<script src="js/state.js"></script>
<script src="js/api.js"></script>
<script src="js/socket.js"></script>
<script src="js/ui.js"></script>
<script src="js/app.js"></script>

</body>
</html>

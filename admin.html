<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Broadcast Ops Console â€” Admin</title>
  <style>
    :root{
      --bg:#0b141a; --panel:#111b21; --ink:#e9edef; --muted:#aebac1; --accent:#53bdeb; --line:#1f2c34;
      --green:#00a884; --red:#ff6b6b; --yellow:#ffd166; --chip:#202c33; --incoming:#202c33; --outgoing:#005c4b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{height:100%;display:grid;grid-template-columns: 360px 1fr 320px}

    /* LEFT: chats list */
    .sidebar{background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .left-head{padding:12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .left-head input{flex:1;background:#111b21;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
    .tab{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--muted);cursor:pointer}
    .tab.active{background:#0e2a36;color:var(--accent)}
    .chatlist{overflow:auto}
    .item{display:grid;grid-template-columns: 44px 1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:hover{background:#0f1f26}
    .avatar{width:44px;height:44px;border-radius:50%;background:#25313a;display:grid;place-items:center;color:#9cc4ff;font-weight:700}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px}
    .badge{background:#1f2c34;color:#9fe1ff;border:1px solid #2b3b45;font-size:11px;border-radius:999px;padding:2px 8px}
    .unread{background:#1fa855;color:white;border:none}

    /* CENTER: thread */
    .thread{display:flex;flex-direction:column;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>')}
    .thread-head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:var(--panel)}
    .thread-head .name{font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);font-size:11px;border-radius:999px;padding:3px 8px}
    .area{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:8px 10px;border-radius:10px;position:relative}
    .in{align-self:flex-start;background:var(--incoming)}
    .out{align-self:flex-end;background:var(--outgoing)}
    .stamp{font-size:11px;color:#b7c7ce;opacity:.85;margin-top:2px}

    /* composer */
    .composer{display:grid;grid-template-columns: 1fr auto auto;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--panel)}
    .composer textarea{width:100%;min-height:40px;resize:vertical;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .takeover{background:var(--yellow);color:#1b1b1b}
    .send{background:var(--green);color:#00170f}
    .quick{background:#0f191f;color:var(--muted)}

    /* RIGHT: info */
    .right{background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
    .right-head{padding:12px;border-bottom:1px solid var(--line);font-weight:600}
    .section{padding:12px;border-bottom:1px solid var(--line)}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:var(--muted)}
    .tag{background:#0f191f;border:1px solid var(--line);color:#9cc4ff;border-radius:999px;padding:3px 8px;font-size:11px;margin:2px;display:inline-block}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:#0f191f;color:var(--ink);border:1px solid var(--line)}

    /* toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0f191f;border:1px solid var(--line);padding:10px 12px;border-radius:8px;display:none}
  </style>
</head>
<body>
<div class="app" id="app">

  <!-- LEFT -->
  <aside class="sidebar">
    <div class="left-head">
      <input id="search" placeholder="Search or filter (name, tag)..." />
    </div>
    <div class="tabs">
      <div class="tab active" data-filter="all">All</div>
      <div class="tab" data-filter="unread">Unread</div>
      <div class="tab" data-filter="attention">Attention</div>
    </div>
    <div class="chatlist" id="chatlist"></div>
  </aside>

  <!-- CENTER -->
  <main class="thread">
    <div class="thread-head">
      <div class="avatar" id="av"></div>
      <div>
        <div class="name" id="who">â€”</div>
        <div class="chips" id="chips"></div>
      </div>
    </div>
    <div class="area" id="area"></div>
    <div class="composer">
      <textarea id="text" placeholder="Write to intervene manually..."></textarea>
      <button class="quick" id="quick">Quick Replies</button>
      <button class="send" id="send">Send</button>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="right">
    <div class="right-head">Contact Card</div>
    <div class="section" id="profile">
      <div class="row"><span>Source</span><span id="src">Whats</span></div>
      <div class="row"><span>Status</span><span id="status">Bot active</span></div>
      <div class="row"><span>Last message</span><span id="last">â€”</span></div>
      <div class="row"><span>Time zone</span><span id="tz">UTCâˆ’6</span></div>
      <div style="margin-top:8px">
        <span class="tag">lead</span><span class="tag">fx</span><span class="tag">broadcast</span>
      </div>
      <div class="buttons">
        <button class="ghost" id="toggle">Take control</button>
        <button class="ghost" id="open8n8">Open in 8n8</button>
        <button class="ghost" id="viewThread">View in source</button>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Notes</div>
      <textarea id="note" style="width:100%;min-height:80px;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px" placeholder="Internal notes (not sent to the client)"></textarea>
      <div class="buttons"><button class="ghost" id="saveNote">Save note</button></div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Quick Actions</div>
      <div class="buttons">
        <button class="ghost" data-quick="Thanks for the reply â€” hereâ€™s our Telegram channel: https://t.me/tradetabofficial">Invite to Telegram</button>
        <button class="ghost" data-quick="All good â€” weâ€™ll keep you posted with neutral market commentary only.">Confirm subscription</button>
        <button class="ghost" data-quick="Understood. Iâ€™ve removed you from the list. You can rejoin anytime.">Unsubscribe</button>
      </div>
    </div>
  </aside>
</div>

<div class="toast" id="toast"></div>

<script>
// --- Mock store --- //
const MOCK = [
  {id:'c1', name:'Marco Trader', initials:'MT', src:'Whats', tags:['fx','vip'], unread:2, needsAttention:true,
    messages:[
      {from:'them', t:'Hey, who is this?'},
      {from:'bot', t:"Hey mate, itâ€™s Hans from TradeTab. Please keep this number private. All good with your trading?"},
      {from:'them', t:'Yes, I trade London open.'}
    ]},
  {id:'c2', name:'Alice FX', initials:'AF', src:'Telegram', tags:['fx'], unread:0, needsAttention:false,
    messages:[{from:'bot', t:'Thanks for joining. Here is the channel: https://t.me/tradetabofficial'}]},
  {id:'c3', name:'Cedric', initials:'C', src:'Whats', tags:['lead'], unread:1, needsAttention:true,
    messages:[{from:'them', t:'Stop sending signals please.'}]}
];

let state = { list:[...MOCK], activeId: 'c1', manual:false };

// --- Helpers --- //
const $ = (id)=>document.getElementById(id);
function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1600);} 

function renderList(){
  const box = $('chatlist');
  const q = $('search').value.toLowerCase();
  const active = state.activeId;
  box.innerHTML='';
  state.list
    .filter(c=> c.name.toLowerCase().includes(q) || c.tags.some(t=>t.includes(q)))
    .forEach(c=>{
      const row = document.createElement('div'); row.className='item'; row.dataset.id=c.id;
      row.innerHTML = `
        <div class="avatar">${c.initials}</div>
        <div>
          <div class="title">${c.name}</div>
          <div class="meta">${c.src} â€¢ ${c.tags.join(', ')}</div>
        </div>
        <div>${c.unread?`<span class="badge unread">${c.unread}</span>`:c.needsAttention?'<span class="badge">âš‘</span>':''}</div>`;
      row.onclick = ()=>{ state.activeId=c.id; renderThread(); renderHeader(); document.querySelectorAll('.item').forEach(i=>i.style.background=''); row.style.background='#0f1f26'; };
      if(c.id===active) row.style.background='#0f1f26';
      box.appendChild(row);
    })
}

function renderHeader(){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  $('who').textContent = c.name;
  $('av').textContent = c.initials;
  $('src').textContent = c.src;
  $('status').textContent = state.manual? 'Operator active' : 'Bot active';
  $('chips').innerHTML = '';
  c.tags.forEach(t=>{ const el=document.createElement('span'); el.className='chip'; el.textContent=t; $('chips').appendChild(el); });
}

function renderThread(){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  const area = $('area'); area.innerHTML='';
  c.messages.forEach(m=>{
    const div = document.createElement('div'); div.className = 'msg '+(m.from==='them'?'in':'out');
    div.innerHTML = `${m.t.replace(/</g,'&lt;')}` + `<div class="stamp">${m.from==='bot'?'ðŸ¤– Bot':'ðŸ‘¤ You'}</div>`;
    area.appendChild(div);
  });
  $('last').textContent = new Date().toLocaleString();
  area.scrollTop = area.scrollHeight;
}

function sendManual(text){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  c.messages.push({from:'you', t:text});
  renderThread();

  // POST to backend (replace route when wiring to 8n8)
  fetch('/api/broadcast/intervene', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ contact_id:c.id, channel:c.src, message:text })
  }).catch(()=>{});
}

// --- Events --- //
$('send').onclick = ()=>{
  const t = $('text').value.trim(); if(!t) return;
  if(!state.manual){ toast('Activate "Take control" to intervene.'); return; }
  sendManual(t); $('text').value='';
};

$('toggle').onclick = ()=>{ state.manual=!state.manual; renderHeader(); toast(state.manual?'You have control':'Bot reactivated'); };
$('search').oninput = renderList;
$('quick').onclick = ()=>{
  const options = [
    "Hey, itâ€™s Hans from TradeTab. Please keep this number private. All good with your trading?",
    "Glad you replied â€” join the Telegram for neutral market commentary: https://t.me/tradetabofficial",
    "Got it. If you prefer no more messages, reply STOP and weâ€™ll unsubscribe you."
  ];
  const pick = prompt('Choose 0â€‘2 to paste:\n0) First touch\n1) Invite to Telegram\n2) Unsubscribe', '0');
  const n = Number(pick); if(!isNaN(n) && options[n]){ $('text').value = options[n]; $('text').focus(); }
};

// Quick actions in right panel
Array.from(document.querySelectorAll('.section .buttons .ghost[data-quick]')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ $('text').value = btn.dataset.quick; $('text').focus(); });
});

$('saveNote').onclick = ()=>{ toast('Note saved'); };
$('open8n8').onclick = ()=>{ toast('Open in 8n8 (pending integration)'); };
$('viewThread').onclick = ()=>{ toast('Open conversation in source (pending)'); };

// init
renderList();
renderHeader();
renderThread();
</script>
</body>
</html>

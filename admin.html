<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Broadcast Ops Console — Admin</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#0b141a; --panel:#111b21; --ink:#e9edef; --muted:#aebac1; --accent:#53bdeb; --line:#1f2c34;
      --green:#00a884; --red:#ff6b6b; --yellow:#ffd166; --chip:#202c33; --incoming:#202c33; --outgoing:#005c4b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{height:100%;display:grid;grid-template-columns: 360px 1fr 320px}

    /* LEFT: chats list */
    .sidebar{background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .left-head{padding:12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .left-head input{flex:1;background:#111b21;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
    .tab{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--muted);cursor:pointer}
    .tab.active{background:#0e2a36;color:var(--accent)}
    .chatlist{overflow:auto}
    .item{display:grid;grid-template-columns: 44px 1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:hover{background:#0f1f26}
    .avatar{width:44px;height:44px;border-radius:50%;background:#25313a;display:grid;place-items:center;color:#9cc4ff;font-weight:700}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px}
    .badge{background:#1f2c34;color:#9fe1ff;border:1px solid #2b3b45;font-size:11px;border-radius:999px;padding:2px 8px}
    .unread{background:#1fa855;color:white;border:none}

    /* CENTER: thread */
    .thread{display:flex;flex-direction:column;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>')}
    .thread-head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:var(--panel)}
    .thread-head .name{font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);font-size:11px;border-radius:999px;padding:3px 8px}
    .area{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:8px 10px;border-radius:10px;position:relative}
    .in{align-self:flex-start;background:var(--incoming)}
    .out{align-self:flex-end;background:var(--outgoing)}
    .stamp{font-size:11px;color:#b7c7ce;opacity:.85;margin-top:2px}
    
    /* Message type indicators */
    .msg[data-type="1"] { border-left: 3px solid #53bdeb; } /* Bot template */
    .msg[data-type="2"] { border-left: 3px solid #00a884; } /* Client */
    .msg[data-type="3"] { border-left: 3px solid #ffd166; } /* AI */
    .msg[data-type="4"] { border-left: 3px solid #ff6b6b; } /* Admin */

    /* composer */
    .composer{display:grid;grid-template-columns: 1fr auto auto;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--panel)}
    .composer textarea{width:100%;min-height:40px;resize:vertical;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .takeover{background:var(--yellow);color:#1b1b1b}
    .send{background:var(--green);color:#00170f}
    .quick{background:#0f191f;color:var(--muted)}

    /* RIGHT: info */
    .right{background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
    .right-head{padding:12px;border-bottom:1px solid var(--line);font-weight:600}
    .section{padding:12px;border-bottom:1px solid var(--line)}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:var(--muted)}
    .tag{background:#0f191f;border:1px solid var(--line);color:#9cc4ff;border-radius:999px;padding:3px 8px;font-size:11px;margin:2px;display:inline-block}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:#0f191f;color:var(--ink);border:1px solid var(--line)}

    /* toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0f191f;border:1px solid var(--line);padding:10px 12px;border-radius:8px;display:none}
  </style>
</head>
<body>
<div class="app" id="app">

  <!-- LEFT -->
  <aside class="sidebar">
    <div class="left-head">
      <input id="search" placeholder="Search or filter (name, tag)..." />
      <button class="ghost" id="refresh" style="padding: 8px; font-size: 12px;">🔄</button>
      <div id="connection-status" style="width: 8px; height: 8px; border-radius: 50%; background: #666; margin-left: 4px;" title="Connection status"></div>
    </div>
    <div class="tabs">
      <div class="tab active" data-filter="all">All</div>
      <div class="tab" data-filter="unread">Unread</div>
      <div class="tab" data-filter="attention">Attention</div>
    </div>
    <div class="chatlist" id="chatlist"></div>
  </aside>

  <!-- CENTER -->
  <main class="thread">
    <div class="thread-head">
      <div class="avatar" id="av"></div>
      <div>
        <div class="name" id="who">—</div>
        <div class="chips" id="chips"></div>
      </div>
    </div>
    <div class="area" id="area"></div>
    <div class="composer">
      <textarea id="text" placeholder="Write to intervene manually..."></textarea>
      <button class="quick" id="quick">Quick Replies</button>
      <button class="send" id="send">Send</button>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="right">
    <div class="right-head">Contact Card</div>
    <div class="section" id="profile">
      <div class="row"><span>Source</span><span id="src">Whats</span></div>
      <div class="row"><span>Phone</span><span id="phone">—</span></div>
      <div class="row"><span>Status</span><span id="status">Bot active</span></div>
      <div class="row"><span>Interview</span><span id="interview">—</span></div>
      <div class="row"><span>Last message</span><span id="last">—</span></div>
      <div class="row"><span>Time zone</span><span id="tz">UTC−6</span></div>
      <div style="margin-top:8px">
        <span class="tag">lead</span><span class="tag">fx</span><span class="tag">broadcast</span>
      </div>
      <div class="buttons">
        <button class="ghost" id="toggle">Take control</button>
        <button class="ghost" id="open8n8">Open in 8n8</button>
        <button class="ghost" id="viewThread">View in source</button>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Notes</div>
      <textarea id="note" style="width:100%;min-height:80px;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px" placeholder="Internal notes (not sent to the client)"></textarea>
      <div class="buttons"><button class="ghost" id="saveNote">Save note</button></div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Message Types</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.4">
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#53bdeb;margin-right:6px"></span>Bot Template</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#00a884;margin-right:6px"></span>Client Message</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ffd166;margin-right:6px"></span>AI Response</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ff6b6b;margin-right:6px"></span>Admin Intervention</div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Quick Actions</div>
      <div class="buttons">
        <button class="ghost" data-quick="Thanks for the reply — here's our Telegram channel: https://t.me/tradetabofficial">Invite to Telegram</button>
        <button class="ghost" data-quick="All good — we'll keep you posted with neutral market commentary only.">Confirm subscription</button>
        <button class="ghost" data-quick="Understood. I've removed you from the list. You can rejoin anytime.">Unsubscribe</button>
      </div>
    </div>
  </aside>
</div>

<div class="toast" id="toast"></div>

<script>
// --- API Configuration --- //
const API_BASE = 'https://broadcast-system-d7ca773e62c8.herokuapp.com';

// Message type mapping
const MESSAGE_TYPES = {
  1: { from: 'bot', label: '🤖 Bot', color: 'out' },      // Generated template message
  2: { from: 'them', label: '👤 Client', color: 'in' },   // Client answers
  3: { from: 'bot', label: '🤖 AI', color: 'out' },       // AI responses
  4: { from: 'admin', label: '👨‍💼 Admin', color: 'out' }  // Admin intervention
};

let state = { list: [], activeId: null, manual: false, loading: false };
let socket = null;

// --- Helpers --- //
const $ = (id)=>document.getElementById(id);
function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1600);}

function updateConnectionStatus(connected) {
  const status = $('connection-status');
  if (connected) {
    status.style.background = '#00a884';
    status.title = 'Connected to real-time updates';
  } else {
    status.style.background = '#ff6b6b';
    status.title = 'Disconnected from real-time updates';
  }
}

// --- Socket.IO Functions --- //
function initSocket() {
  try {
    socket = io(API_BASE);
    
    socket.on('connect', () => {
      console.log('Connected to server');
      toast('Connected to real-time updates');
      updateConnectionStatus(true);
    });
    
    socket.on('disconnect', () => {
      console.log('Disconnected from server');
      toast('Disconnected from real-time updates');
      updateConnectionStatus(false);
    });
    
    socket.on('recibedMessage', (data) => {
      console.log('New message received:', data);
      handleNewMessage(data);
    });

    socket.on('IAsendMessage', (data) => {
      console.log('New message sent by AI:', data);
      handleNewMessage(data);
    });
    
    socket.on('conversation_updated', (data) => {
      console.log('Conversation updated:', data);
      fetchConversations(); // Refresh the entire list
    });
    
    socket.on('user_typing', (data) => {
      console.log('User typing:', data);
      // You could add a typing indicator here
    });
    
    socket.on('sendMessage', (data) => {
      console.log('Message sent successfully:', data);
      toast('Message sent successfully');
    });
    
  } catch (error) {
    console.error('Socket connection error:', error);
  }
}

async function handleNewMessage(data) {
  const { number, message, typo } = data;

  
  const response = await fetch(`${API_BASE}/m/get/info/${data.number}`);
  

  
  // Find the conversation by phone number
  const conversation = state.list.find(c => c.number === number);
  if (conversation) {
    // Add the new message to the conversation
    const newMessage = {
      id: Date.now(), // Temporary ID, should be provided by backend
      from: MESSAGE_TYPES[typo]?.from || 'unknown',
      type: typo,
      label: MESSAGE_TYPES[typo]?.label || 'Unknown',
      color: MESSAGE_TYPES[typo]?.color || 'in',
      text: message,
      timestamp: new Date()
    };
    
    conversation.messages.push(newMessage);
    
    // Update the UI if this conversation is currently active
    if (state.activeId === conversation.id) {
      renderThread();
    }
    
    // Update the conversation list
    renderList();
    
    toast(`New message from ${conversation.name}`);
  }
}

// --- API Functions --- //
async function fetchConversations() {
  try {
    state.loading = true;
    const response = await fetch(`${API_BASE}/m/get/all`);
    const data = await response.json();

    if (data.status === 200) {
      state.list = data.numbers.map((number, index) => ({
        id: `c${index + 1}`,
        name: number.name,
        initials: getInitials(number.name),
        number: number.number,
        src: 'Whats',
        tags: ['lead', 'fx'],
        unread: 0,
        needsAttention: !number.interview,
        interview: number.interview,
        messages: (number.history || []).map(msg => ({
          id: msg.id,
          from: MESSAGE_TYPES[msg.typo]?.from || 'unknown',
          type: msg.typo,
          label: MESSAGE_TYPES[msg.typo]?.label || 'Unknown',
          color: MESSAGE_TYPES[msg.typo]?.color || 'in',
          text: msg.message,
          timestamp: new Date() // You might want to add timestamp to your API
        }))
      }));
      
      if (state.list.length > 0 && !state.activeId) {
        state.activeId = state.list[0].id;
      }
      
      renderList();
      renderHeader();
      renderThread();
    } else {
      toast('Error loading conversations');
    }
  } catch (error) {
    console.error('Error fetching conversations:', error);
    toast('Failed to load conversations');
  } finally {
    state.loading = false;
  }
}

function getInitials(name) {
  return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
}

async function sendIntervention(contactId, message) {
  try {
    const contact = state.list.find(c => c.id === contactId);
    if (!contact) return;
    
    console.log("contact.number", contact.number, "message", message);

    const response = await fetch(`${API_BASE}/m/send/to/number`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        number: contact.number,
        message: message
      })
    });
    
    if (response.ok) {
      // Add message to local state
      contact.messages.push({
        id: Date.now(),
        from: 'admin',
        type: 4,
        label: '👨‍💼 Admin',
        color: 'out',
        text: message,
        timestamp: new Date()
      });
      
      renderThread();
      toast('Message sent successfully');
    } else {
      toast('Failed to send message');
    }
  } catch (error) {
    console.error('Error sending intervention:', error);
    toast('Failed to send message');
  }
} 

function renderList(){
  const box = $('chatlist');
  const q = $('search').value.toLowerCase();
  const active = state.activeId;
  box.innerHTML='';
  
  if (state.loading) {
    box.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">Loading conversations...</div>';
    return;
  }
  
  if (state.list.length === 0) {
    box.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No conversations found</div>';
    return;
  }
  
  const filteredList = state.list.filter(c => {
    const matchesName = c.name.toLowerCase().includes(q);
    const matchesTags = c.tags.some(t => t.toLowerCase().includes(q));
    const matchesNumber = c.number && c.number.includes(q);
    return matchesName || matchesTags || matchesNumber;
  });
  
  filteredList.forEach(c=>{
      const row = document.createElement('div'); row.className='item'; row.dataset.id=c.id;
      row.innerHTML = `
        <div class="avatar">${c.initials}</div>
        <div>
          <div class="title">${c.name}</div>
          <div class="meta">${c.src} • ${c.messages.length} messages • ${c.tags.join(', ')}</div>
        </div>
        <div>${c.unread?`<span class="badge unread">${c.unread}</span>`:c.needsAttention?'<span class="badge">⚑</span>':c.messages.length === 0?'<span class="badge" style="background:#666">New</span>':''}</div>`;
      row.onclick = ()=>{ state.activeId=c.id; renderThread(); renderHeader(); document.querySelectorAll('.item').forEach(i=>i.style.background=''); row.style.background='#0f1f26'; };
      if(c.id===active) row.style.background='#0f1f26';
      box.appendChild(row);
    })
}

function renderHeader(){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  $('who').textContent = c.name;
  $('av').textContent = c.initials;
  $('src').textContent = c.src;
  $('phone').textContent = c.number || '—';
  $('interview').textContent = c.interview ? 'Completed' : 'Pending';
  $('status').textContent = state.manual? 'Operator active' : 'Bot active';
  $('chips').innerHTML = '';
  c.tags.forEach(t=>{ const el=document.createElement('span'); el.className='chip'; el.textContent=t; $('chips').appendChild(el); });
}

function renderThread(){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  const area = $('area'); area.innerHTML='';
  
  // Check if conversation has no messages
  if (c.messages.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.style.cssText = 'text-align: center; padding: 40px 20px; color: var(--muted);';
    emptyDiv.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
      <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No messages yet</div>
      <div style="font-size: 14px;">Start a conversation with ${c.name}</div>
      <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">Click "Take control" and send a message</div>
    `;
    area.appendChild(emptyDiv);
    $('last').textContent = 'No messages';
    return;
  }
  
  // Sort messages by ID to maintain chronological order
  const sortedMessages = [...c.messages].sort((a, b) => a.id - b.id);
  
  console.log('sortedMessages', sortedMessages);
  sortedMessages.forEach(m=>{
    const div = document.createElement('div'); 
    div.className = `msg ${m.color}`;
    div.setAttribute('data-type', m.type);
    div.innerHTML = `${m.text?.replace(/</g,'&lt;').replace(/\n/g,'<br>')}` + `<div class="stamp">${m.label}</div>`;
    area.appendChild(div);
  });
  
  $('last').textContent = new Date().toLocaleString();
  area.scrollTop = area.scrollHeight;
}

async function sendManual(text){
  const c = state.list.find(x=>x.id===state.activeId);
  if(!c) return;
  
  await sendIntervention(c.id, text);
}

// --- Events --- //
$('send').onclick = ()=>{
  const t = $('text').value.trim(); if(!t) return;
  if(!state.manual){ toast('Activate "Take control" to intervene.'); return; }
  sendManual(t); $('text').value='';
};

$('toggle').onclick = ()=>{ state.manual=!state.manual; renderHeader(); toast(state.manual?'You have control':'Bot reactivated'); };
$('search').oninput = renderList;
$('refresh').onclick = ()=>{ fetchConversations(); toast('Refreshing conversations...'); };
$('quick').onclick = ()=>{
  const options = [
    "Hey, it’s Hans from TradeTab. Please keep this number private. All good with your trading?",
    "Glad you replied — join the Telegram for neutral market commentary: https://t.me/tradetabofficial",
    "Got it. If you prefer no more messages, reply STOP and we’ll unsubscribe you."
  ];
  const pick = prompt('Choose 0‑2 to paste:\n0) First touch\n1) Invite to Telegram\n2) Unsubscribe', '0');
  const n = Number(pick); if(!isNaN(n) && options[n]){ $('text').value = options[n]; $('text').focus(); }
};

// Quick actions in right panel
Array.from(document.querySelectorAll('.section .buttons .ghost[data-quick]')).forEach(btn=>{
  btn.addEventListener('click', ()=>{ $('text').value = btn.dataset.quick; $('text').focus(); });
});

$('saveNote').onclick = ()=>{ toast('Note saved'); };
$('open8n8').onclick = ()=>{ toast('Open in 8n8 (pending integration)'); };
$('viewThread').onclick = ()=>{ toast('Open conversation in source (pending)'); };

// init
fetchConversations();
initSocket();
</script>
</body>
</html>

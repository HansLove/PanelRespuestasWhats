<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Broadcast Ops Console — Admin (Modular)</title>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#0b141a; --panel:#111b21; --ink:#e9edef; --muted:#aebac1; --accent:#53bdeb; --line:#1f2c34;
      --green:#00a884; --red:#ff6b6b; --yellow:#ffd166; --chip:#202c33; --incoming:#202c33; --outgoing:#005c4b;
      
      /* Safe area insets for iPhone */
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-right: env(safe-area-inset-right);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      
      /* Dynamic viewport height for mobile keyboards */
      --vh: 1vh;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      /* Default desktop body - no safe area padding */
    }
    
    /* Desktop layout - default */
    .app{
      height:100%;
      display:block;
      position: relative;
    }
    
    /* Default main-content for desktop */
    .main-content {
      display: grid;
      grid-template-columns: 360px 1fr 320px;
      grid-template-rows: 1fr;
      height: 100%;
      width: 100%;
    }
    
    /* Hide mobile navigation by default (desktop) */
    .mobile-nav {
      display: none;
    }

    /* LEFT: chats list */
    .sidebar{background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
    .left-head{padding:12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
    .left-head input{flex:1;background:#111b21;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
    .tabs{display:flex;gap:6px;padding:8px 12px;border-bottom:1px solid var(--line)}
    .tab{padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--muted);cursor:pointer}
    .tab.active{background:#0e2a36;color:var(--accent)}
    .chatlist{overflow:auto}
    .item{display:grid;grid-template-columns: 44px 1fr auto;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:hover{background:#0f1f26}
    .avatar{width:44px;height:44px;border-radius:50%;background:#25313a;display:grid;place-items:center;color:#9cc4ff;font-weight:700}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px}
    .badge{background:#1f2c34;color:#9fe1ff;border:1px solid #2b3b45;font-size:11px;border-radius:999px;padding:2px 8px}
    .unread{background:#1fa855;color:white;border:none}

    /* CENTER: thread */
    .thread{display:flex;flex-direction:column;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>')}
    .thread-head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line);background:var(--panel);flex-shrink:0}
    .thread-head .name{font-weight:600}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);font-size:11px;border-radius:999px;padding:3px 8px}
    .area{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth;position:relative;min-height:0}
    .in{align-self:flex-start;background:var(--incoming)}
    .out{align-self:flex-end;background:var(--outgoing)}
    
    /* Message type indicators */
    .msg[data-type="1"] { border-left: 3px solid #53bdeb; } /* Bot template */
    .msg[data-type="2"] { border-left: 3px solid #00a884; } /* Client */
    .msg[data-type="3"] { border-left: 3px solid #ffd166; } /* AI */
    .msg[data-type="4"] { border-left: 3px solid #ff6b6b; } /* Admin */

    /* composer */
    .composer{display:grid;grid-template-columns: 1fr auto auto auto;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--panel);flex-shrink:0}
    .composer textarea{width:100%;min-height:40px;resize:vertical;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px}
    button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
    .takeover{background:var(--yellow);color:#1b1b1b}
    .send{background:var(--green);color:#00170f}
    .quick{background:#0f191f;color:var(--muted)}
    
    /* Voice recording menu */
    .voice-menu-container{position:relative;display:inline-block}
    .voice-record{
      background:#0f191f;color:var(--muted);min-width:40px;height:40px;
      display:flex;align-items:center;justify-content:center;font-size:16px;
      transition:all 0.3s ease;position:relative;
    }
    .voice-record:hover{background:var(--chip);color:var(--accent)}
    .voice-record.recording{
      background:var(--red);color:white;animation:pulse 1.5s ease-in-out infinite;
    }
    .voice-record.recording::after{
      content:'';position:absolute;width:100%;height:100%;border-radius:8px;
      border:2px solid var(--red);animation:recording-pulse 1.5s ease-in-out infinite;
    }
    
    /* Voice dropdown menu */
    .voice-dropdown{
      position:absolute;bottom:100%;right:0;
      background:var(--panel);border:1px solid var(--line);
      border-radius:8px;min-width:280px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      display:none;z-index:1500;margin-bottom:8px;
    }
    .voice-dropdown.show{display:block !important;border:2px solid var(--accent) !important;}
    
    .voice-option{
      display:flex;align-items:center;gap:12px;
      padding:12px 16px;cursor:pointer;
      transition:all 0.2s ease;
    }
    .voice-option:hover{background:var(--chip)}
    .voice-option:first-child{border-radius:8px 8px 0 0}
    .voice-option:last-child{border-radius:0 0 8px 8px}
    
    .voice-icon{
      font-size:18px;width:24px;text-align:center;
      flex-shrink:0;
    }
    .voice-details{flex:1}
    .voice-name{
      font-weight:600;color:var(--ink);
      font-size:14px;margin-bottom:2px;
    }
    .voice-desc{
      font-size:12px;color:var(--muted);
      line-height:1.3;
    }
    
    .voice-separator{
      height:1px;background:var(--line);
      margin:4px 0;
    }
    
    .record-option{border-bottom:1px solid var(--line)}
    .record-option:hover{background:var(--accent);color:white}
    .record-option:hover .voice-name{color:white}
    .record-option:hover .voice-desc{color:rgba(255,255,255,0.8)}
    
    /* Recording animations */
    @keyframes recording-pulse{
      0%{transform:scale(1);opacity:1}
      100%{transform:scale(1.3);opacity:0}
    }
    
    /* Recording indicator overlay */
    .recording-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.8);z-index:2000;display:none;
      align-items:center;justify-content:center;flex-direction:column;
    }
    .recording-indicator{
      background:var(--panel);border:1px solid var(--line);
      padding:32px;border-radius:16px;text-align:center;max-width:300px;
    }
    .recording-waveform{
      display:flex;justify-content:center;gap:3px;margin:20px 0;
    }
    .recording-bar{
      width:4px;height:20px;background:var(--red);border-radius:2px;
      animation:recording-waveform 1.2s ease-in-out infinite;
    }
    .recording-bar:nth-child(1){animation-delay:0s;height:15px}
    .recording-bar:nth-child(2){animation-delay:0.1s;height:25px}
    .recording-bar:nth-child(3){animation-delay:0.2s;height:18px}
    .recording-bar:nth-child(4){animation-delay:0.3s;height:30px}
    .recording-bar:nth-child(5){animation-delay:0.4s;height:22px}
    .recording-bar:nth-child(6){animation-delay:0.5s;height:16px}
    
    @keyframes recording-waveform{
      0%,100%{transform:scaleY(0.3);opacity:0.7}
      50%{transform:scaleY(1);opacity:1}
    }
    
    .recording-time{font-size:24px;font-weight:600;color:var(--red);margin:10px 0}
    .recording-actions{display:flex;gap:12px;margin-top:20px}
    .cancel-recording{background:var(--muted);color:var(--bg)}
    .stop-recording{background:var(--red);color:white}

    /* RIGHT: info */
    .right{background:var(--panel);border-left:1px solid var(--line);display:flex;flex-direction:column}
    .right-head{padding:12px;border-bottom:1px solid var(--line);font-weight:600}
    .section{padding:12px;border-bottom:1px solid var(--line)}
    .row{display:flex;justify-content:space-between;margin:6px 0;color:var(--muted)}
    .tag{background:#0f191f;border:1px solid var(--line);color:#9cc4ff;border-radius:999px;padding:3px 8px;font-size:11px;margin:2px;display:inline-block}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:#0f191f;color:var(--ink);border:1px solid var(--line)}

    /* Message improvements */
    .message-container{display:flex;flex-direction:column;gap:8px;min-height:100%}
    .msg{max-width:70%;padding:10px 12px;border-radius:12px;position:relative;transition:transform 0.2s ease,box-shadow 0.2s ease;cursor:default}
    .msg:hover{box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .message-content{line-height:1.4;word-wrap:break-word}
    .stamp{font-size:11px;color:#b7c7ce;opacity:.7;margin-top:4px;display:flex;justify-content:space-between}
    
    /* Scroll improvements */
    .area::-webkit-scrollbar{width:6px}
    .area::-webkit-scrollbar-track{background:transparent}
    .area::-webkit-scrollbar-thumb{background:var(--line);border-radius:3px}
    .area::-webkit-scrollbar-thumb:hover{background:var(--muted)}
    
    /* Animations */
    @keyframes slideInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes slideOutDown{from{transform:translateY(0);opacity:1}to{transform:translateY(20px);opacity:0}}
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    @keyframes bounce{0%,20%,53%,80%,100%{transform:translateY(0)}40%,43%{transform:translateY(-10px)}}
    
    /* Scroll to bottom indicator */
    .scroll-indicator{
      position:fixed;
      bottom:120px;
      right:20px;
      background:var(--accent);
      color:white;
      width:40px;
      height:40px;
      border-radius:50%;
      display:none;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:1000;
      animation:bounce 2s infinite;
      box-shadow:0 4px 12px rgba(83,189,235,0.3);
    }
    
    /* New message indicator */
    .new-message-indicator{animation:slideInUp 0.3s ease}
    
    /* Typing indicator */
    .typing-indicator{display:flex;align-items:center;gap:4px;padding:8px 12px;background:var(--incoming);border-radius:12px;max-width:70%;align-self:flex-start;margin:4px 0}
    .typing-dots{display:flex;gap:2px}
    .typing-dots span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:typing 1.4s infinite ease-in-out}
    .typing-dots span:nth-child(1){animation-delay:-0.32s}
    .typing-dots span:nth-child(2){animation-delay:-0.16s}
    @keyframes typing{0%,80%,100%{transform:scale(0.8);opacity:0.5}40%{transform:scale(1);opacity:1}}
    
    /* Audio message styles */
    .audio-message{min-width:250px;max-width:100%}
    .audio-controls{display:flex;align-items:center;gap:8px;padding:4px}
    .audio-play-btn{
      width:36px;height:36px;border-radius:50%;background:var(--accent);color:white;border:none;
      display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;
      font-size:12px;
    }
    .audio-play-btn:hover{background:#4a9fd1;transform:scale(1.05)}
    .audio-play-btn:active{transform:scale(0.95)}
    
    .audio-progress{flex:1;display:flex;flex-direction:column;gap:4px;position:relative}
    .audio-waveform{display:flex;align-items:end;gap:2px;height:24px}
    .waveform-bar{
      width:3px;background:var(--muted);border-radius:2px;transition:all 0.2s ease;
      height:8px;opacity:0.6;
    }
    .waveform-bar:nth-child(1){height:12px}
    .waveform-bar:nth-child(2){height:18px}
    .waveform-bar:nth-child(3){height:14px}
    .waveform-bar:nth-child(4){height:20px}
    .waveform-bar:nth-child(5){height:16px}
    .waveform-bar:nth-child(6){height:10px}
    .waveform-bar:nth-child(7){height:22px}
    .waveform-bar:nth-child(8){height:15px}
    
    .audio-progress-bar{
      position:absolute;bottom:0;left:0;right:0;height:2px;background:rgba(255,255,255,0.2);
      border-radius:1px;overflow:hidden;
    }
    .progress-fill{height:100%;background:var(--accent);width:0%;transition:width 0.1s ease}
    
    .audio-time{font-size:11px;color:var(--muted);min-width:35px;text-align:right}
    .audio-download-btn{
      background:transparent;border:none;color:var(--muted);cursor:pointer;
      padding:4px;border-radius:4px;transition:all 0.2s ease;font-size:12px;
    }
    .audio-download-btn:hover{background:var(--chip);color:var(--ink)}
    
    /* Audio message animations */
    .waveform-bar.playing{
      background:var(--accent);opacity:1;
      animation:waveform 1.5s ease-in-out infinite;
    }
    .waveform-bar.playing:nth-child(1){animation-delay:0s}
    .waveform-bar.playing:nth-child(2){animation-delay:0.1s}
    .waveform-bar.playing:nth-child(3){animation-delay:0.2s}
    .waveform-bar.playing:nth-child(4){animation-delay:0.3s}
    .waveform-bar.playing:nth-child(5){animation-delay:0.4s}
    .waveform-bar.playing:nth-child(6){animation-delay:0.5s}
    .waveform-bar.playing:nth-child(7){animation-delay:0.6s}
    .waveform-bar.playing:nth-child(8){animation-delay:0.7s}
    
    @keyframes waveform{
      0%,100%{transform:scaleY(1)}
      50%{transform:scaleY(1.5)}
    }
    
    /* Enhanced hover states */
    .item:hover{background:#0f1f26;transform:translateX(2px);transition:all 0.2s ease}
    .tab{transition:all 0.2s ease}
    .tab:hover{background:#1a2b33;transform:translateY(-1px)}
    button{transition:all 0.2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.2)}
    button:active{transform:translateY(0)}
    
    /* Desktop specific styles - ensure panels are properly positioned */
    @media (min-width: 769px) {
      body {
        overflow: initial !important;
        padding: 0 !important;
      }
      
      .app {
        height: 100vh !important;
        width: 100vw !important;
        display: block !important;
        position: relative !important;
        overflow: hidden !important;
      }
      
      .sidebar, .thread, .right {
        position: static !important;
        transform: none !important;
        width: auto !important;
        height: 100% !important;
        z-index: auto !important;
        transition: none !important;
      }
      
      .sidebar {
        background: var(--panel);
        border-right: 1px solid var(--line);
        display: flex;
        flex-direction: column;
      }
      
      .thread {
        display: flex;
        flex-direction: column;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><rect width="32" height="32" fill="%23111b21"/><path d="M0 16h32M16 0v32" stroke="%231f2c34" stroke-width="1"/></svg>');
        height: 100%;
        min-height: 0;
      }
      
      .right {
        background: var(--panel);
        border-left: 1px solid var(--line);
        display: flex;
        flex-direction: column;
      }
      
      /* Reset mobile composer styles for desktop */
      .composer {
        display: grid !important;
        grid-template-columns: 1fr auto auto auto !important;
        gap: 8px !important;
        padding: 10px !important;
        border-top: 1px solid var(--line);
        background: var(--panel);
        position: static !important;
        transform: none !important;
        z-index: auto !important;
        flex-shrink: 0 !important;
      }
      
      /* Desktop area styles for proper scrolling */
      .area {
        flex: 1 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        min-height: 0 !important;
        height: auto !important;
        max-height: calc(100vh - 120px) !important;
      }
      
      /* Desktop message container styles */
      .message-container {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
        min-height: 100% !important;
        padding-bottom: 20px !important;
      }
      
      .composer textarea {
        width: 100%;
        min-height: 40px;
        resize: vertical;
        background: #0f191f;
        color: var(--ink);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px;
        font-size: 14px !important;
        touch-action: auto;
      }
      
      .send {
        background: var(--green);
        color: #00170f;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
        min-width: auto;
        height: auto;
        border-radius: 8px;
        display: initial;
        align-items: initial;
        justify-content: initial;
        font-size: 14px;
      }
      
      .quick {
        display: block !important;
        background: #0f191f;
        color: var(--muted);
      }
      
      .voice-record {
        min-width: 40px;
        height: 40px;
        border-radius: 8px;
        font-size: 16px;
      }
      
      /* Hide mobile navigation completely on desktop */
      .mobile-nav {
        display: none !important;
      }
      
      .main-content {
        display: grid !important;
        grid-template-columns: 360px 1fr 320px !important;
        grid-template-rows: 1fr !important;
        width: 100% !important;
        height: 100% !important;
        position: static !important;
        overflow: visible !important;
      }
      
      /* Ensure panels are proper grid items */
      .main-content > .sidebar,
      .main-content > .thread,
      .main-content > .right {
        display: flex !important;
        flex-direction: column !important;
        position: static !important;
        transform: none !important;
        width: auto !important;
        height: 100% !important;
      }
    }
    
    /* Hide mobile navigation on desktop */
    .mobile-nav, .mobile-panels {
      display: none;
    }
    
    /* === MOBILE RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
      body{
        font-size:14px;
        overflow:hidden;
        margin:0;
        padding:0;
        /* iPhone safe area support - mobile only */
        padding-top: var(--safe-area-inset-top);
        padding-left: var(--safe-area-inset-left);
        padding-right: var(--safe-area-inset-right);
      }
      
      .app{
        height: calc(var(--vh, 1vh) * 100);
        min-height: -webkit-fill-available;
        width:100vw;
        display:flex;
        flex-direction:column;
        grid-template-columns:none;
        grid-template-rows:none;
        position:relative;
        overflow:hidden;
      }
      
      /* Show mobile navigation and content */
      .mobile-nav {
        display:flex !important;
      }
      
      .main-content {
        display:block !important;
        flex:1;
        position:relative;
        overflow:hidden;
        width:100%;
      }
      
      /* Mobile navigation bar - modern tab design */
      .mobile-nav{
        display:flex;
        background:var(--panel);
        border-bottom:1px solid var(--line);
        z-index:1100;
        position:relative;
        height:60px;
        flex-shrink:0;
        padding:0 8px;
      }
      
      .mobile-nav-btn{
        flex:1;
        padding:8px 4px;
        background:transparent;
        color:var(--muted);
        border:none;
        font-size:11px;
        cursor:pointer;
        transition:all 0.3s ease;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:2px;
        border-radius:8px;
        margin:4px 2px;
        position:relative;
      }
      
      .mobile-nav-btn.active{
        color:var(--accent);
        background:rgba(83,189,235,0.1);
        transform:scale(1.05);
      }
      
      .mobile-nav-btn.active::after{
        content:'';
        position:absolute;
        bottom:0;
        left:50%;
        transform:translateX(-50%);
        width:20px;
        height:2px;
        background:var(--accent);
        border-radius:1px;
      }
      
      .mobile-nav-btn:active{
        transform:scale(0.95);
      }
      
      .mobile-nav-icon{
        font-size:18px;
        margin-bottom:2px;
      }
      
      /* Mobile panels - full width, smooth transitions */
      .sidebar, .thread, .right{
        position:absolute;
        top:0;
        left:0;
        width:100vw;
        height:100%;
        background:var(--bg);
        transform:translateX(100%);
        transition:transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index:1;
        overflow:hidden;
        display:flex;
        flex-direction:column;
      }
      
      .sidebar.active{transform:translateX(0);z-index:10;border:3px solid lime}
      .thread.active{transform:translateX(0);z-index:10;border:3px solid red}
      .right.active{transform:translateX(0);z-index:10;border:3px solid blue}
      
      /* === MOBILE SIDEBAR (Conversations) === */
      .sidebar{
        background:var(--bg);
        border-right:none;
      }
      
      .left-head{
        padding:16px;
        border-bottom:1px solid var(--line);
        background:var(--panel);
      }
      
      .left-head input{
        font-size:16px;
        padding:12px 16px;
        border-radius:12px;
        width:100%;
      }
      
      .tabs{
        padding:12px 16px;
        background:var(--panel);
        border-bottom:1px solid var(--line);
      }
      .tab{
        padding:10px 16px;
        font-size:14px;
        border-radius:8px;
        margin-right:8px;
      }
      
      .chatlist{
        flex:1;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
        padding:8px 0;
      }
      
      .item{
        padding:16px;
        grid-template-columns:48px 1fr auto;
        gap:12px;
        margin:0 8px;
        border-radius:12px;
        border-bottom:none;
      }
      
      .item:hover{
        background:var(--chip);
        transform:none;
      }
      
      .avatar{width:48px;height:48px;font-size:16px}
      .title{font-size:16px;font-weight:600}
      .meta{font-size:13px;margin-top:2px}
      
      /* === MOBILE THREAD (Chat) === */
      .thread{
        background:var(--bg);
      }
      
      .thread-head{
        padding:16px;
        background:var(--panel);
        border-bottom:1px solid var(--line);
        display:flex;
        align-items:center;
        gap:12px;
        flex-shrink:0;
      }
      
      .area{
        flex:1;
        padding:16px;
        overflow-y:auto;
        -webkit-overflow-scrolling:touch;
        overscroll-behavior:contain;
        scroll-behavior:smooth;
        background:var(--bg);
      }
      
      .msg{
        max-width:80%;
        padding:12px 16px;
        margin:6px 0;
        font-size:15px;
        line-height:1.4;
        border-radius:16px;
      }
      
      .stamp{font-size:12px;margin-top:8px;opacity:0.8}
      
      /* === MOBILE COMPOSER === */
      .composer{
        padding: calc(16px + var(--safe-area-inset-bottom)) 16px 16px 16px;
        grid-template-columns:1fr auto auto;
        gap:12px;
        background:var(--panel);
        border-top:1px solid var(--line);
        flex-shrink:0;
        position: relative;
        z-index: 100;
        /* Ensure composer stays above keyboard */
        transform: translateZ(0);
      }
      
      .composer textarea{
        font-size:16px;
        min-height:44px;
        padding:12px 16px;
        border-radius:24px;
        border:1px solid var(--line);
        background:var(--bg);
        /* Prevent iOS zoom on focus */
        font-size: 16px !important;
        /* Better touch target */
        touch-action: manipulation;
        /* Prevent textarea resize on mobile */
        resize: none;
        /* Ensure proper keyboard behavior */
        -webkit-appearance: none;
        appearance: none;
      }
      
      /* Fix for iOS keyboard overlay */
      .composer textarea:focus {
        outline: 2px solid var(--accent);
        outline-offset: 2px;
        /* Ensure input stays visible above keyboard */
        position: relative;
        z-index: 101;
      }
      
      .send{
        min-width:48px;
        height:48px;
        border-radius:50%;
        padding:0;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:18px;
      }
      
      .voice-record{
        min-width:48px;
        height:48px;
        border-radius:50%;
        font-size:18px;
      }
      
      .quick{display:none}
      
      /* === MOBILE CONTACT CARD (Right Panel) === */
      .right{
        background:var(--bg);
        border-left:none;
        padding:0;
      }
      
      .right-head{
        padding:20px 16px;
        border-bottom:1px solid var(--line);
        font-weight:600;
        font-size:18px;
        background:var(--panel);
        text-align:center;
        color:var(--ink);
      }
      
      .section{
        margin:16px;
        padding:20px;
        border:1px solid var(--line);
        border-radius:16px;
        background:var(--panel);
      }
      
      .row{
        padding:8px 0;
        font-size:15px;
        border-bottom:1px solid rgba(255,255,255,0.1);
      }
      
      .row:last-child{border-bottom:none}
      
      /* PROMINENT Take Control Button */
      .buttons{
        display:flex;
        gap:12px;
        flex-direction:column;
        margin-top:20px;
      }
      
      .buttons button{
        width:100%;
        padding:16px 20px;
        font-size:16px;
        border-radius:12px;
        font-weight:600;
        transition:all 0.3s ease;
      }
      
      #toggle{
        background:linear-gradient(135deg, var(--accent), #4a9fd1) !important;
        color:white !important;
        font-size:18px !important;
        padding:20px !important;
        border-radius:16px !important;
        box-shadow:0 6px 20px rgba(83,189,235,0.4) !important;
        border:none !important;
        position:relative;
        overflow:hidden;
      }
      
      #toggle::before{
        content:'🎮';
        margin-right:8px;
        font-size:20px;
      }
      
      #toggle:active{
        transform:scale(0.98);
        box-shadow:0 4px 15px rgba(83,189,235,0.6) !important;
      }
      
      /* Mobile-specific improvements */
      .toast{
        bottom:80px;
        right:12px;
        left:12px;
        width:auto;
      }
      
      .new-message-indicator{
        bottom:100px;
        right:20px;
      }
      
      /* Enhanced touch interactions */
      .item{
        transition:all 0.2s ease;
      }
      
      .item:active{
        background:var(--accent);
        transform:scale(0.98);
        color:white;
      }
      
      .item:active .title,
      .item:active .meta{
        color:white;
      }
      
      button:active{
        transform:scale(0.95);
      }
      
      /* Smooth panel transitions */
      .sidebar, .thread, .right{
        will-change:transform;
      }
      
      /* Loading states */
      .loading{
        opacity:0.7;
        pointer-events:none;
      }
      
      /* Enhanced visual feedback */
      .mobile-nav-btn{
        position:relative;
        overflow:hidden;
      }
      
      .mobile-nav-btn::before{
        content:'';
        position:absolute;
        top:50%;
        left:50%;
        width:0;
        height:0;
        background:rgba(83,189,235,0.2);
        border-radius:50%;
        transform:translate(-50%, -50%);
        transition:all 0.3s ease;
      }
      
      .mobile-nav-btn:active::before{
        width:100px;
        height:100px;
      }
      
      /* Prevent zoom on double tap */
      .thread-head, .composer, .sidebar{
        touch-action:manipulation;
      }
      
      /* Better focus states for mobile */
      input:focus, textarea:focus{
        outline:2px solid var(--accent);
        outline-offset:2px;
      }
      
      /* iPhone specific fixes */
      @supports (-webkit-touch-callout: none) {
        .app {
          /* Use dynamic viewport height for iOS */
          height: calc(var(--vh, 1vh) * 100);
          min-height: -webkit-fill-available;
        }
        
        .composer {
          /* Extra bottom padding for iPhone home indicator */
          padding-bottom: calc(16px + var(--safe-area-inset-bottom, 20px));
          /* Stick to bottom on iOS */
          position: sticky;
          bottom: 0;
        }
        
        .composer textarea {
          /* Prevent zoom on iOS */
          font-size: 16px !important;
          transform: scale(1);
          /* Fix for iOS keyboard behavior */
          -webkit-user-select: text;
          user-select: text;
        }
        
        /* Fix for iOS keyboard pushing content */
        .thread.active {
          padding-bottom: var(--safe-area-inset-bottom, 0px);
        }
      }
      
      /* Keyboard open state for iPhone */
      body.keyboard-open .composer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: var(--panel);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
      }
      
      body.keyboard-open .thread.active {
        padding-bottom: 100px; /* Space for fixed composer */
      }
      
      body.keyboard-open .area {
        padding-bottom: 20px;
      }
      
      /* Improve scrollbar on mobile */
      .area::-webkit-scrollbar, .chatlist::-webkit-scrollbar, .right::-webkit-scrollbar{
        width:2px;
      }
      
      /* Mobile audio message adjustments */
      .audio-message{min-width:200px}
      .audio-controls{gap:6px}
      .audio-play-btn{width:32px;height:32px;font-size:11px}
      .waveform-bar{width:2px}
      .audio-time{font-size:10px;min-width:30px}
      .audio-download-btn{padding:2px;font-size:11px}
      
      /* Mobile voice recording adjustments */
      .voice-record{min-width:36px;height:36px;font-size:14px}
      .voice-dropdown{
        min-width:260px;right:-20px;
        box-shadow:0 4px 20px rgba(0,0,0,0.4);
      }
      .voice-option{padding:10px 14px;gap:10px}
      .voice-name{font-size:13px}
      .voice-desc{font-size:11px}
    }
    
    /* Small mobile phones (320px - 480px) */
    @media (max-width: 480px) {
      .left-head{padding:8px 10px}
      .left-head input{padding:8px 10px}
      
      .thread-head{padding:10px}
      .area{padding:10px}
      .composer{padding:10px}
      
      .msg{
        max-width:90%;
        padding:8px 10px;
        font-size:13px;
      }
      
      .item{padding:10px}
      .avatar{width:36px;height:36px;font-size:12px}
      .title{font-size:14px}
      .meta{font-size:11px}
      
      /* Mobile voice recording adjustments */
      .voice-record{min-width:36px;height:36px;font-size:14px}
      .composer{grid-template-columns: 1fr auto auto;gap:4px}
      .quick{display:none}
      
      /* Mobile voice dropdown */
      .voice-dropdown{
        min-width:260px;right:-20px;
        box-shadow:0 4px 20px rgba(0,0,0,0.4);
      }
      .voice-option{padding:10px 14px;gap:10px}
      .voice-name{font-size:13px}
      .voice-desc{font-size:11px}
    }
    
    /* Tablet styles (769px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .app{grid-template-columns: 300px 1fr 280px}
      .msg{max-width:80%}
      .composer textarea{font-size:15px}
    }
    
    /* Large desktop (1025px+) */
    @media (min-width: 1025px) {
      .app{grid-template-columns: 360px 1fr 320px}
      .msg{max-width:70%}
    }
    
    /* Help modal */
    .help-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;z-index:2000;align-items:center;justify-content:center}
    .help-content{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:24px;max-width:400px;width:90%}
    .help-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--ink)}
    .help-shortcut{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)}
    .help-shortcut:last-child{border-bottom:none}
    .help-key{background:var(--chip);color:var(--accent);padding:4px 8px;border-radius:4px;font-family:monospace;font-size:12px}
    .help-desc{color:var(--muted);font-size:14px}
    .help-close{background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:6px;margin-top:16px;cursor:pointer}
    
    /* toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0f191f;border:1px solid var(--line);padding:10px 12px;border-radius:8px;display:none;z-index:1001}
  </style>
</head>
<body>
<div class="app" id="app">
  
  <!-- Mobile Navigation -->
  <nav class="mobile-nav" id="mobile-nav">
    <button class="mobile-nav-btn active" data-panel="conversations">
      <div class="mobile-nav-icon">💬</div>
      <div>Chats</div>
    </button>
    <button class="mobile-nav-btn" data-panel="chat">
      <div class="mobile-nav-icon">📱</div>
      <div>Chat</div>
    </button>
    <button class="mobile-nav-btn" data-panel="contact">
      <div class="mobile-nav-icon">👤</div>
      <div>Contact</div>
    </button>
  </nav>

  <!-- Main Content Container -->
  <div class="main-content" id="main-content">
  
    <!-- LEFT PANEL: Conversations -->
    <aside class="sidebar" id="conversations-panel">
    <div class="left-head">
      <input id="search" placeholder="Search or filter (name, tag)..." />
      <button class="ghost" id="refresh" style="padding: 8px; font-size: 12px;">🔄</button>
      <button class="ghost" id="help" style="padding: 8px; font-size: 12px;" title="Keyboard shortcuts (?)">?</button>
      <div id="connection-status" style="width: 8px; height: 8px; border-radius: 50%; background: #666; margin-left: 4px;" title="Connection status"></div>
    </div>
    <div class="tabs">
      <div class="tab active" data-filter="all">All</div>
      <div class="tab" data-filter="unread">Unread</div>
      <div class="tab" data-filter="attention">Attention</div>
    </div>
    <div class="chatlist" id="chatlist"></div>
  </aside>

  <!-- CENTER -->
  <main class="thread">
    <div class="thread-head">
      <div class="avatar" id="av"></div>
      <div>
        <div class="name" id="who">—</div>
        <div class="chips" id="chips"></div>
      </div>
    </div>
    <div class="area" id="area"></div>
    <div class="composer">
      <textarea id="text" placeholder="Write to intervene manually..."></textarea>
      <div class="voice-menu-container">
        <button class="voice-record" id="voice-record" title="Voice options">🎙️</button>
        <div class="voice-dropdown" id="voice-dropdown">
          <!-- Options will be populated dynamically by JavaScript -->
        </div>
      </div>
      <button class="quick" id="quick">Quick Replies</button>
      <button class="send" id="send">Send</button>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="right">
    <div class="right-head">Contact Card</div>
    <div class="section" id="profile">
      <div class="row"><span>Source</span><span id="src">Whats</span></div>
      <div class="row"><span>Phone</span><span id="phone">—</span></div>
      <div class="row"><span>Status</span><span id="status">Bot active</span></div>
      <div class="row"><span>Interview</span><span id="interview">—</span></div>
      <div class="row"><span>Last message</span><span id="last">—</span></div>
      <div class="row"><span>Time zone</span><span id="tz">UTC−6</span></div>
      <div style="margin-top:8px">
        <span class="tag">lead</span><span class="tag">fx</span><span class="tag">broadcast</span>
      </div>
      <div class="buttons">
        <button class="ghost" id="toggle">Take control</button>
        <button class="ghost" id="open8n8">Open in 8n8</button>
        <button class="ghost" id="viewThread">View in source</button>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Notes</div>
      <textarea id="note" style="width:100%;min-height:80px;background:#0f191f;color:var(--ink);border:1px solid var(--line);border-radius:8px;padding:8px" placeholder="Internal notes (not sent to the client)"></textarea>
      <div class="buttons"><button class="ghost" id="saveNote">Save note</button></div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Message Types</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.4">
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#53bdeb;margin-right:6px"></span>Bot Template</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#00a884;margin-right:6px"></span>Client Message</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ffd166;margin-right:6px"></span>AI Response</div>
        <div style="display:flex;align-items:center;margin:4px 0"><span style="width:12px;height:3px;background:#ff6b6b;margin-right:6px"></span>Admin Intervention</div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Quick Actions</div>
      <div class="buttons">
        <button class="ghost" data-quick="Thanks for the reply — here's our Telegram channel: https://t.me/tradetabofficial">Invite to Telegram</button>
        <button class="ghost" data-quick="All good — we'll keep you posted with neutral market commentary only.">Confirm subscription</button>
        <button class="ghost" data-quick="Understood. I've removed you from the list. You can rejoin anytime.">Unsubscribe</button>
      </div>
    </div>
    </aside>
  </div> <!-- End main-content -->
</div>

<div class="toast" id="toast"></div>

<!-- Scroll to bottom indicator -->
<div class="scroll-indicator" id="scroll-indicator" title="Scroll to bottom">
  ↓
</div>

<!-- Voice Recording Overlay -->
<div class="recording-overlay" id="recording-overlay">
  <div class="recording-indicator">
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--ink);">Recording Voice Note</div>
    <div class="recording-waveform">
      <div class="recording-bar"></div>
      <div class="recording-bar"></div>
      <div class="recording-bar"></div>
      <div class="recording-bar"></div>
      <div class="recording-bar"></div>
      <div class="recording-bar"></div>
    </div>
    <div class="recording-time" id="recording-time">00:00</div>
    <div class="recording-actions">
      <button class="cancel-recording" id="cancel-recording">Cancel</button>
      <button class="stop-recording" id="stop-recording">Stop & Send</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="help-modal" id="help-modal">
  <div class="help-content">
    <div class="help-title">Keyboard Shortcuts</div>
    <div class="help-shortcut">
      <div class="help-desc">Refresh conversations</div>
      <div class="help-key">Ctrl+R</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Toggle manual mode</div>
      <div class="help-key">Ctrl+T</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Focus search</div>
      <div class="help-key">Ctrl+F</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Scroll to bottom</div>
      <div class="help-key">Ctrl+End</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Clear search / Focus input</div>
      <div class="help-key">Esc</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Send message</div>
      <div class="help-key">Enter</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Record voice note</div>
      <div class="help-key">🎙️ Click</div>
    </div>
    <div class="help-shortcut">
      <div class="help-desc">Show this help</div>
      <div class="help-key">?</div>
    </div>
    <button class="help-close" onclick="document.getElementById('help-modal').style.display='none'">Close</button>
  </div>
</div>

<!-- iPhone viewport height fix -->
<script>
// Fix for iPhone viewport height and keyboard handling
function setVH() {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// Set initial viewport height
setVH();

// Update on resize (keyboard open/close)
window.addEventListener('resize', setVH);

// Additional iPhone keyboard handling
if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
  // Prevent zoom on input focus
  document.addEventListener('touchstart', function() {}, {passive: true});
  
  // Handle keyboard show/hide
  let initialViewportHeight = window.innerHeight;
  
  window.addEventListener('resize', function() {
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;
    
    // Keyboard is likely open if height decreased by more than 150px
    if (heightDifference > 150) {
      document.body.classList.add('keyboard-open');
      // Scroll to focused element
      setTimeout(() => {
        const focused = document.activeElement;
        if (focused && focused.tagName === 'TEXTAREA') {
          focused.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 300);
    } else {
      document.body.classList.remove('keyboard-open');
    }
  });
}
</script>

<!-- Load modular JavaScript files -->
<script src="js/config.js"></script>
<script src="js/state.js"></script>
<script src="js/api.js"></script>
<script src="js/socket.js"></script>
<script src="js/ui.js"></script>
<script src="js/app.js"></script>

</body>
</html>